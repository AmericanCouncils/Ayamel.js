<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
	<script src="https://raw.github.com/BYU-ARCLITE/TimedText/master/Cue.js"></script>
	<script src="https://raw.github.com/BYU-ARCLITE/TimedText/master/WebVTT.js"></script>
	<script src="https://raw.github.com/BYU-ARCLITE/TimedText/master/SRT.js"></script>
	<script src="https://raw.github.com/BYU-ARCLITE/Ayamel.js/master/Ayamel.js"></script>
	<script src="https://raw.github.com/BYU-ARCLITE/Ayamel.js/master/Text.js"></script>
	<script src="https://raw.github.com/BYU-ARCLITE/Ayamel.js/master/Caption.js"></script>
	<script src="captionWrapper.js"></script>
	<script src="Timeline.js"></script>
	<script src="Slider.js"></script>
	<script src="Placeholder.js"></script>
	<script src="TimelineAction.js"></script>
	<script src="TimelineTracker.js"></script>
	<script src="TimelinePersistence.js"></script>
	<script src="TimelineView.js"></script>
	<script src="TextTrack.js"></script>
	<script src="WaveForm.js"></script>
	<script src="AudioTrack.js"></script>
</head>
<style type="text/css">
	body {
		margin: 0;
		padding: 0;
	}
	#video {
		background: grey;
		position: relative;
		height: 300px;
		width: 500px;
	}
	#editor, #linediv {
		display: none;
	}
	#left, #right {
		margin-top: 20px;
		float: left;
		width: 50%;
		height: 400px;
	}
</style>
<body>
<div id="left">
	Add caption track: <input type="file" id="vttfile" /><button id="tbtn">Empty Track</button><br/>
	Add audio track: <input type="file" id="audiofile" /><br/><br/>
	<center>
	<div id="editor">
	<textarea id="cue_text" placeholder="Cue text will appear here."></textarea><br/>
	<table style="text-align:center;">
		<tr><td><label for="cue_align">Alignment:</label></td><td><label for="cue_snap">Positioning:</label></td></tr>
		<tr>
			<td>
				<select id="cue_align">
					<option value="start">Start</option>
					<option value="middle" selected>Middle</option> 
					<option value="end">End</option>
				</select>
			</td><td>
				<select id="cue_snap">
					<option value="auto">Auto</option>
					<option value="snap">Snap-to-Lines</option>
					<option value="percent">Percent</option>
				</select>
			</td>
		</tr>
		<tr id="linediv">
			<td colspan=2>
				<label for="cue_line">Line Number</label>
				<input id="cue_line" type="range" value=0/>
			</td>
		</tr>
		<tr><td><label for="cue_pos">Indentation</label></td><td><label for="cue_size">Caption Size</label></td></tr>
		<tr><td><input id="cue_pos" type="range" value=50/></td><td><input id="cue_size" type="range" value=100 min=0 max=100 /></td></tr>
	</table>
	</center>
	</div>
</div>
<div id="right">
	<div id="video"></div>
	<audio id="controls" controls="controls">
		<source src="music.ogg" type="audio/ogg" />
		<source src="music.mp3" type="audio/mp3" />
		Your browser does not support the audio tag.
	</audio><br />
</div>
<button id="selb">SELECT</button>
<button id="movb"> MOVE </button>
<button id="resb">RESIZE</button>
<button id="creb">CREATE</button>
<button id="delb">DELETE</button>
<button id="repb">REPEAT</button>
<button id="scrb">SCROLL</button>
<button id="undb"> UNDO </button>
<select id="activetracks" multiple><option value="new" selected>new</option></select>
<div id="tl"></div>

<script type="text/javascript">
	var timeline, t_count = 0,
		screen =  document.getElementById("video"),
		editor = document.getElementById("editor"),
		controls = document.getElementById("controls"),
		atracks = document.getElementById("activetracks");

	var cue = null, grain = 0,
		caption = null, captions = {},
		text_el = document.getElementById("cue_text"),
		align_el = document.getElementById("cue_align"),
		snap_el = document.getElementById("cue_snap"),
		line_form = document.getElementById("linediv"),
		line_el = document.getElementById("cue_line"),
		pos_el = document.getElementById("cue_pos"),
		size_el = document.getElementById("cue_size");	
	
	function text_change(){
		if(!cue) return;
		timeline.setText(this.value);
		caption.Update(cue);
		grain = parseInt(getComputedStyle(caption.el).lineHeight,10);
	}

	function line_change(){
		if(!cue) return;
		cue.rawLine = this.valueAsNumber;
		caption.Update(cue);
	}
	
	function pos_change(){
		if(!cue) return;
		cue.position = this.value+"%";
		caption.Update(cue);
		grain = parseInt(getComputedStyle(caption.el).lineHeight,10);
	}
	
	function size_change(){
		if(!cue) return;
		cue.size = this.value+"%";
		caption.Update(cue);
		grain = parseInt(getComputedStyle(caption.el).lineHeight,10);
	}
	
	function align_change(){
		if(!cue) return;
		cue.align = this.value;
		caption.Update(cue);
	}
	
	function snap_change(){
		if(!cue) return;
		var cheight, cstyle;
		if(this.value === "auto"){
			cue.snapToLines = true;
			cue.rawLine = "auto";
			line_form.style.display = "none";	
		}else{
			cstyle = getComputedStyle(caption.el);
			cheight = parseInt(getComputedStyle(video).height,10);
			switch(this.value){
				case "percent":
					cue.snapToLines = false;
					if(cue.rawLine === 'auto'){
						cue.rawLine = 0;
					}else if(cue.rawLine < 0){
						cue.rawLine = Math.round(100*(1-(parseInt(cstyle.bottom,10)+parseInt(cstyle.height,10))/cheight));
					}else{
						cue.rawLine = Math.round(100*parseInt(cstyle.top,10)/cheight);
					}
					line_el.type = "range";
					line_el.max = 100;
					line_el.min = 0;
					break;
				case "snap":
					cue.snapToLines = true;
					cue.rawLine = cue.rawLine==='auto'?0:Math.round(parseInt(cstyle.top,10)*cheight/(100*grain));
					line_el.type = "number"
					line_el.max = null;
					line_el.min = null;
					break;
			}
			line_el.value = cue.rawLine;
			line_form.style.display = "inline";
		}
		caption.Update(cue);
	};

	function updateEditor(){
		text_el.removeEventListener('change', text_change);
		text_el.value = cue.text;
		text_el.addEventListener('change', text_change, false);
		
		size_el.removeEventListener('change', size_change);
		size_el.value = parseInt(cue.size,10);
		size_el.addEventListener('change', size_change, false);
		
		align_el.removeEventListener('change', align_change);
		align_el.value = cue.align;
		align_el.addEventListener('change', align_change, false);
		
		snap_el.removeEventListener('change', snap_change);
		snap_el.value = cue.snapToLines?(cue.rawLine==='auto'?'auto':'snap'):'percent';
		if(snap_el.value === "auto"){
			line_form.style.display = "none";	
		}else{
			switch(snap_el.value){
				case "percent":
					line_el.type = "range";
					line_el.max = 100;
					line_el.min = 0;
					break;
				case "snap":
					line_el.type = "number"
					line_el.max = null;
					line_el.min = null;
					break;
			}
			line_form.style.display = "inline";
		}
		snap_el.addEventListener('change', snap_change, false);
		
		line_el.removeEventListener('change', line_change);
		line_el.value = cue.rawLine;
		line_el.addEventListener('change', line_change, false);
		
		pos_el.removeEventListener('change', pos_change);
		pos_el.value = parseInt(cue.pos,10);
		pos_el.addEventListener('change', pos_change, false);
		
		grain = parseInt(getComputedStyle(caption.el).lineHeight,10);
	}

document.getElementById('vttfile').addEventListener('change', function(evt) {
	timeline.loadTextTrack(evt.target.files[0]);
}, false);

document.getElementById('audiofile').addEventListener('change', function(evt) {
	var file = evt.target.files[0]; // FileList object
	var reader = new FileReader();
	// Closure to capture the file information.
	reader.onload = function(evt) {
		(new webkitAudioContext).decodeAudioData(evt.target.result, function(buffer) {
			var i,j,frame,chan,
				wave = new WaveForm(
				timeline.view.width,
				timeline.trackHeight,
				1,//buffer.numberOfChannels,
				buffer.sampleRate/2);
			console.log("Decoded");
			chan = buffer.getChannelData(0);
			frame = new Float32Array(Math.floor(chan.length/2));
			for(i=0,j=0;i<frame.length;i++,j+=2){
				frame[i] = (chan[j]+chan[j+1])/2;
			}
			console.log("downsampled");
			wave.addFrame(frame);
			console.log("loaded");
			timeline.addAudioTrack(wave,file.name);
			timeline.setAudioTrack("new",file.name);
		}, function(err){
			console.log(err);
		});
	};
	reader.onerror = function(e){alert(e);};
	reader.readAsArrayBuffer(file);
}, false);

document.getElementById('tbtn').addEventListener('click', function() {
	timeline.addTextTrack([], "track"+(t_count++), "en", false);
	timeline.render();
}, false);

// Create the timeline
timeline = new Timeline(document.getElementById("tl"), 7000, 0, 240);
timeline.addTextTrack([], "new", "en", false);

// Define the timeline callbacks
timeline.on('select',function(seg) {
	cue = seg.cue;
	if(!(seg.uid in captions)){
		captions[seg.uid] = Ayamel.Caption.FromCue(captionWrapper,null,seg.cue);
	}
	caption = captions[seg.uid];
	grain = parseInt(getComputedStyle(caption.el).lineHeight,10);
	updateEditor();
	editor.style.display = "block";
});
timeline.on('unselect',function() {
	cue = null;
	editor.style.display = "none";
});
timeline.on('jump', function(time) {
	controls.currentTime = time;
});
timeline.on('segments',function(segs){
	segs.invalid.forEach(function(seg){
		captions[seg.uid].hide();
	});
	segs.valid.forEach(function(seg){
		if(!(seg.uid in captions)){
			captions[seg.uid] = Ayamel.Caption.FromCue(captionWrapper,null,seg.cue);
		}
		captions[seg.uid].display(video);
	});
});
timeline.on('addtrack',function(track){
	var opt = new Option(track.id);
	opt.selected = true;
	atracks.add(opt);
});

// Bind to the audio events
controls.addEventListener("timeupdate", function() {
	timeline.currentTime = controls.currentTime;
});
//Bind the toolbar buttons
document.getElementById("selb").addEventListener('click',function(){
	timeline.currentTool = Timeline.SELECT;
});
document.getElementById("movb").addEventListener('click',function(){
	timeline.currentTool = Timeline.MOVE;
});
document.getElementById("resb").addEventListener('click',function(){
	timeline.currentTool = Timeline.RESIZE;
});
document.getElementById("creb").addEventListener('click',function(){
	timeline.currentTool = Timeline.CREATE;
});
document.getElementById("delb").addEventListener('click',function(){
	timeline.currentTool = Timeline.DELETE;
});
document.getElementById("repb").addEventListener('click',function(){
	timeline.currentTool = Timeline.REPEAT;		
});
document.getElementById("scrb").addEventListener('click',function(){
	timeline.currentTool = Timeline.SCROLL;		
});
document.getElementById("undb").addEventListener('click',function(){
	timeline.tracker.undo();		
});
atracks.addEventListener('change',function(){
	var i, opts = atracks.options,
		len = opts.length;
	for(i=0;i<len;i++){
		timeline.getTrack(opts[i].value).active = opts[i].selected;
	}
});
//need time for images to load
setTimeout(function(){timeline.render();},100);

</script>

</body>
</html>